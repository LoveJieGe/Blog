@model HxBlogs.WebApp.Models.BasicInfoDTO
@{
    Layout = "~/Areas/Admin/Views/Shared/_UCLayout.cshtml";
}
@section styles{
    @Styles.Render("~/content/picker")
    @Styles.Render("~/content/remind")
    <link href="~/Plugins/dropzone/css/basic.css" rel="stylesheet" />
    <link href="~/Plugins/dropzone/css/dropzone.css" rel="stylesheet" />
}
<div class="d-flex hx-container hx-white-container py-3">
    <div>
        @{
            Html.RenderPartial("side");
        }
    </div>
    <div class="flex-fill flex-grow-1 ml-2 px-3">
        @{
            Html.RenderPartial("tabs", Model, new ViewDataDictionary {
                {"JobInfo",ViewBag.JobInfo }
            });
        }
    </div>
</div>
@section scripts{
    @Scripts.Render("~/bundles/picker")
    @Scripts.Render("~/bundles/jqueryval")
    @Scripts.Render("~/bundles/unobtrusive")
    @Scripts.Render("~/bundles/remind")
    @Scripts.Render("~/bundles/core")
    <script src="~/Plugins/dropzone/js/dropzone.js"></script>
    <script>
        var _hxDialog;
        $(function () {
            $("#uploadavatar").dropzone({
                url: "/file/uploadavatar",
                maxFiles: 1,
                maxFilesize: 1024,
                acceptedFiles: ".jpg,.jpeg",
                autoProcessQueue: false,
                paramName: "file",
                dictDefaultMessage: "拖入需要上传的文件",
                init: function () {
                    var myDropzone = this, submitButton =$("#btn_upload");
                    myDropzone.on('addedfile', function (file) {
                        debugger
                        //添加上传文件的过程，可再次弹出弹框，添加上传文件的信息
                    });
                    myDropzone.on('sending', function (data, xhr, formData) {
                        debugger
                        //向后台发送该文件的参数
                        formData.append('watermark', jQuery('#info').val());
                    });
                    myDropzone.on('success', function (files, response) {
                        //文件上传成功之后的操作
                    });
                    myDropzone.on('error', function (files, response) {
                        //文件上传失败后的操作
                    });
                    myDropzone.on('totaluploadprogress', function (progress, byte, bytes) {
                        debugger
                        //progress为进度百分比
                        //$("#pro").text("上传进度：" + parseInt(progress) + "%");
                        ////计算上传速度和剩余时间
                        //var mm = 0;
                        //var byte = 0;
                        //var tt = setInterval(function () {
                        //    mm++;
                        //    var byte2 = bytes;
                        //    var remain;
                        //    var speed;
                        //    var byteKb = byte / 1024;
                        //    var bytesKb = bytes / 1024;
                        //    var byteMb = byte / 1024 / 1024;
                        //    var bytesMb = bytes / 1024 / 1024;
                        //    if (byteKb <= 1024) {
                        //        speed = (parseFloat(byte2 - byte) / (1024) / mm).toFixed(2) + " KB/s";
                        //        remain = (byteKb - bytesKb) / parseFloat(speed);
                        //    } else {
                        //        speed = (parseFloat(byte2 - byte) / (1024 * 1024) / mm).toFixed(2) + " MB/s";
                        //        remain = (byteMb - bytesMb) / parseFloat(speed);
                        //    }
                        //    $("#dropz #speed").text("上传速率：" + speed);
                        //    $("#dropz #time").text("剩余时间" + arrive_timer_format(parseInt(remain)));
                        //    if (bytes >= byte) {
                        //        clearInterval(tt);
                        //        if (byteKb <= 1024) {
                        //            $("#dropz #speed").text("上传速率：0 KB/s");
                        //        } else {
                        //            $("#dropz #speed").text("上传速率：0 MB/s");
                        //        }
                        //        $("#dropz #time").text("剩余时间：0:00:00");
                        //    }
                        //}, 1000);
                    });
                    submitButton.on('click', function () {
                        //点击上传文件
                        myDropzone.processQueue();
                    });
                    //cancelButton.addEventListener('click', function () {
                    //    //取消上传
                    //    myDropzone.removeAllFiles();
                    //});
                }
            });
            //剩余时间格式转换：
            function arrive_timer_format(s) {
                var t;
                if (s > -1) {
                    var hour = Math.floor(s / 3600);
                    var min = Math.floor(s / 60) % 60;
                    var sec = s % 60;
                    var day = parseInt(hour / 24);
                    if (day > 0) {
                        hour = hour - 24 * day;
                        t = day + "day " + hour + ":";
                    }
                    else t = hour + ":";
                    if (min < 10) { t += "0"; }
                    t += min + ":";
                    if (sec < 10) { t += "0"; }
                    t += sec;
                }
                return t;
            }

            $('.date-picker').datepicker({
                autoclose:true,
                format: 'yyyy-mm-dd',
                orientation:'auto bottom',
                language: 'zh-CN'
            });
            $('#basicForm').validate({
                errorElement: 'span',
                errorClass: 'text-danger',
                //提交表单后，（第一个）未通过验证的表单获得焦点
                focusInvalid: true,
                //当未通过验证的元素获得焦点时，移除错误提示
                //focusCleanup: true,
                rules: {
                    NickName: {
                        required: true,
                        minlength: 2,
                        maxlength: 320,
                        checkNickName: true,
                    },
                    RealName: {
                        checkRealName:true
                    },
                    Mobile: {
                        checkMobile:true
                    },
                    QQ: {
                        checkQQ: true
                    },
                    WeChat: {
                        checkWeChat:true
                    }
                },
                messages: {
                    NickName: {
                        required: '昵称不能为空!'
                    }
                },
                errorPlacement: function (error, element) {
                    $(element).next().hide();
                    error.addClass(['small ','my-auto']).insertAfter(element);
                },
                ////display error alert on form submit
                invalidHandler: function (event, validator) {
                    $('.alert-error', $('#basicForm')).show();
                },
                //highlight: function (element) {
                //    $(element).closest('.form-row').addClass('error');
                //},
                success: function (error, element) {
                    //error.closest('.form-row').removeClass('error');
                    $(error).next().show();
                    error.remove();
                }
            });
            $('#WorkYear').val('@ViewBag.JobInfo.WorkYear');
            $('.hx-avatar').mouseenter(function () {
                var first = $(this).children().first();
                first.removeClass('hx-hidden').addClass('hx-visiable hx-active');
            }).mouseleave(function () {
                var first = $(this).children().first();
                first.removeClass(['hx-visiable', 'hx-active']).addClass('hx-hidden');
            });
            $('.btn-edit-avatar').click(function () {
                _hxDialog = alertify.hxDialog($('#imageDialog').removeAttr('hidden')[0]);
            });
        })
        var uc = function () {
            var basic = {
                begin: function () {
                    var submitBtn = $('#basicForm').find('input[type=submit]');
                    if (submitBtn.hasClass('disabled')) {
                        return false;
                    }
                    submitBtn.addClass('disabled');
                },
                success: function (data, textStatus, jqXHR) {
                    hxCore.ajaxSuccess(jqXHR, function (data) {
                        hxCore.remindSuccess('用户基本资料修改成功!');
                    });
                },
                failure(r) {
                    hxCore.ajaxError(r);
                },
                finish:function(){
                    var submitBtn = $('#basicForm').find('input[type=submit]');
                    if (submitBtn.hasClass('disabled')) {
                        submitBtn.removeClass('disabled');
                    }
                }
            }
            var job = {
                begin: function () {
                    var submitBtn = $('#jobForm').find('input[type=submit]');
                    if (submitBtn.hasClass('disabled')) {
                        return false;
                    }
                    submitBtn.addClass('disabled');
                },
                success: function (data, textStatus, jqXHR) {
                    hxCore.ajaxSuccess(jqXHR, function (data) {
                        hxCore.remindSuccess('职业技能修改成功!');
                    });
                },
                failure(r) {
                    hxCore.ajaxError(r);
                },
                finish: function () {
                    var submitBtn = $('#jobForm').find('input[type=submit]');
                    if (submitBtn.hasClass('disabled')) {
                        submitBtn.removeClass('disabled');
                    }
                }
            };
            return {
                basic,
                job
            }
        }();
    </script>
}

